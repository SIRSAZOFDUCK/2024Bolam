### Association between deprivation and the prescribing of oral contracption in primary care in England
### Bolam K et cl. 2024 


## Define paths

rm(list=ls()) # Clear environment

path.data.prescribing <- "C:/Users/sirsa/OneDrive/Desktop/Warwick/Research/Data/EPD"

## Load packages -----

library(dplyr)
library(data.table)
library(fingertipsR)



## Load data -----

## Load prescribing data

# Set working directory
setwd(path.data.prescribing)

# Define data months to include
included.months <- list("202204", "202205", "202206", "202207", "202208", "202209", "202210", "202211", "202221", "202301", "202302", "202303")

# Read in data
for(i in included.months){
  file = paste0("EPD_",i,".csv") # Define file naming convention
  x <- fread(file = file, header = T, sep = ",") # read in data file
  assign(paste0("data",i), x) # save as dataframe object
}


## Load IMD scores by practice

# Fingertips API (see https://fingertips.phe.org.uk/documents/fingertips_api_guide.pdf and https://github.com/ropensci/fingertipsR)

profiles <- profiles() # Show PHOF profiles. Use to identify which profile set you need. Here we use profile ID 21 [National General Practice Profiles (supporting indicators)]

inds <- indicators(ProfileID = "21") # Show indicators for selected PHOF profile. Here we use indicator ID 93553 [IMD 2019 score]

areas <- area_types() # Show area types. Here we use area type 7 [General practice]

data.imd <- fingertips_data(IndicatorID = 93553, AreaTypeID = 7) %>% # IMD scores by GP practice
  filter(Timeperiod == "2019") %>% # Keep IMD(2019) scores only
  filter(AreaType != "England") %>% # Remove England value
  select(AreaCode, AreaName, ParentName, Value) %>% # Keep required fields only
  rename("gp.code" = "AreaCode", # Rename columns
         "gp.name" = "AreaName",
         "pcn.name" = "ParentName",
         "imd.score" = "Value")
  

